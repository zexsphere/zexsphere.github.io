<!doctype html><html lang=en><head><meta charset=utf-8><meta name=referrer content="same-origin"><title>CMake components - use GTest :: Zex</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="关于单元测试，比较关注的点
易用，将过程专注于测试 方便，可以构造测试的前提条件，重复使用 直观，结果可视化，增强反馈 先来看 cmake 自带的测试驱动程序 ctest，ctest 当且仅当返回值为 0 时，测试成功。这样一来，ctest 框架可以容纳各种语言的测试脚本，扩展性强。但由于一个返回条目只对应一个测试用例，因此更适合用作集成测试，用在单元测试上属于折磨人。
敲定了集成测试，在单元测试上再来对比对比 cunit 和 gtest。
单元测试框架 cunit gtest 的核心思想是一样的。
+----------------------------------------------+ | unit test +---------------+ | | +---------------+ +---&amp;gt;+ test 1 | | | | | | +---------------+ | +------&amp;gt;+ Suit 1 +--+ . | | | | | | +---------------+ | +---------------- | | +---------------+ +---&amp;gt;+ test n | | | | | | . +---------------+ | | Registry +--+ +----------------------------------------------+ | | | ."><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=/post/0008/><link rel=stylesheet href=/assets/style.min.css?d41d8cd98f00b204e9800998ecf8427e><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/favicon/apple-icon-precomposed.png><link rel="shortcut icon" href=/img/favicon/orange.png><meta name=twitter:card content="summary"><meta property="og:type" content="article"><meta property="og:title" content="CMake components - use GTest :: Zex"><meta property="og:description" content="Regarding unit testing, the key points of focus are: User-friendly: tests should be easy to use and focus on the testing process. Convenient: test preconditions can be easily constructed and reused. Intuitive: visualize results and provide enhanced feedback."><meta property="og:url" content="/post/0008/"><meta property="og:site_name" content="Zex"><meta property="og:image" content="/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-09-08 12:43:38 +0800 +0800"></head><body><div class="container center headings--one-size"><header class=header style=background-image:url(/img/mountain/mountains-g47d3aaa15_1280.jpg);background-position:50%;background-repeat:no-repeat;background-size:cover><div class=header__inner><div class=header__logo><a href=/><div class=logo>Zex</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li><li><a href=/explore>Explore</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li><li><a href=/explore>Explore</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title>CMake components - use GTest</h1><div class=post-meta><span class=post-date>2023-09-08</span>
<span class=post-author>::
zexsphere</span></div><span class=post-tags>#<a href=/tags/test/>test</a>&nbsp;
#<a href=/tags/cmake/>cmake</a>&nbsp;</span><div class=post-content><div><p>关于单元测试，比较关注的点</p><ul><li>易用，将过程专注于测试</li><li>方便，可以构造测试的前提条件，重复使用</li><li>直观，结果可视化，增强反馈</li></ul><p>先来看 cmake 自带的测试驱动程序 ctest，ctest 当且仅当返回值为 0 时，测试成功。这样一来，ctest 框架可以容纳各种语言的测试脚本，扩展性强。但由于一个返回条目只对应一个测试用例，因此更适合用作集成测试，用在单元测试上属于折磨人。</p><p>敲定了集成测试，在单元测试上再来对比对比 cunit 和 gtest。</p><h2 id=单元测试框架>单元测试框架<a href=#单元测试框架 class=hanchor arialabel=Anchor>⚓</a></h2><p>cunit gtest 的核心思想是一样的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>                       +----------------------------------------------+
</span></span><span class=line><span class=cl>                       <span class=p>|</span> unit <span class=nb>test</span>                 +---------------+  <span class=p>|</span>
</span></span><span class=line><span class=cl>                       <span class=p>|</span>   +---------------+  +---&gt;+    <span class=nb>test</span> <span class=m>1</span>     <span class=p>|</span>  <span class=p>|</span>
</span></span><span class=line><span class=cl>                       <span class=p>|</span>   <span class=p>|</span>               <span class=p>|</span>  <span class=p>|</span>    +---------------+  <span class=p>|</span>
</span></span><span class=line><span class=cl>                   +------&gt;+    Suit <span class=m>1</span>     +--+            .          <span class=p>|</span>
</span></span><span class=line><span class=cl>                   <span class=p>|</span>   <span class=p>|</span>   <span class=p>|</span>               <span class=p>|</span>  <span class=p>|</span>    +---------------+  <span class=p>|</span>
</span></span><span class=line><span class=cl>+----------------  <span class=p>|</span>   <span class=p>|</span>   +---------------+  +---&gt;+    <span class=nb>test</span> n     <span class=p>|</span>  <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>               <span class=p>|</span>  <span class=p>|</span>   <span class=p>|</span>          .                +---------------+  <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   Registry    +--+   +----------------------------------------------+
</span></span><span class=line><span class=cl><span class=p>|</span>               <span class=p>|</span>  <span class=p>|</span>              .                +---------------+
</span></span><span class=line><span class=cl>+----------------  <span class=p>|</span>       +---------------+  +---&gt;+    <span class=nb>test</span> <span class=m>1</span>     <span class=p>|</span>
</span></span><span class=line><span class=cl>                   <span class=p>|</span>       <span class=p>|</span>               <span class=p>|</span>  <span class=p>|</span>    +---------------+
</span></span><span class=line><span class=cl>                   +------&gt;+    Suit m     +--+            .
</span></span><span class=line><span class=cl>                           <span class=p>|</span>               <span class=p>|</span>  <span class=p>|</span>    +---------------+
</span></span><span class=line><span class=cl>                           +---------------+  +---&gt;+    <span class=nb>test</span> n     <span class=p>|</span>
</span></span><span class=line><span class=cl>                                                   +---------------+
</span></span></code></pre></div><p>gtest 在易用性上做得更好，接口封装的很干净。支持事件机制，方便性也满足了，最后看下可视化方面。</p><h2 id=可视化>可视化<a href=#可视化 class=hanchor arialabel=Anchor>⚓</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 执行 gtest 程序，并输出为 xml</span>
</span></span><span class=line><span class=cl>$ ./a.out --gtest_output<span class=o>=</span>xml:./result.xml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># xml 转 html</span>
</span></span><span class=line><span class=cl><span class=c1># 参考 https://gitlab.uni-koblenz.de/agrt/gtest2html readme介绍</span>
</span></span></code></pre></div><p>可视化上 cunit 自带显示 xml 的方式，gtest 需要第三方工具转换。</p><p>有一说一，cunit 输出页面风格还是很好看的。</p><h2 id=集成到-cmake>集成到 CMake<a href=#集成到-cmake class=hanchor arialabel=Anchor>⚓</a></h2><p>cmake 版本，1.13 开始需要 c++14 的支持，1.12 需要 c++11。大多实际项目也不会盲目引进 c++14 的特性，因此，指定 1.12 一般够用了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>set</span><span class=p>(</span><span class=s>CMAKE_CXX_STANDARD</span> <span class=s>11</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>set</span><span class=p>(</span><span class=s>CMAKE_CXX_STANDARD_REQUIRED</span> <span class=s>ON</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>find_package</span><span class=p>(</span><span class=s>GTest</span> <span class=s>QUIET</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>if</span><span class=p>(</span><span class=s>NOT</span> <span class=s>GTest_FOUND</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>include</span><span class=p>(</span><span class=s>FetchContent</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>FetchContent_Declare</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s>googletest</span>
</span></span><span class=line><span class=cl>        <span class=s>GIT_REPOSITORY</span> <span class=s>https://github.com/google/googletest.git</span>
</span></span><span class=line><span class=cl>        <span class=s>GIT_TAG</span> <span class=s>release-1.12.0</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=c># FetchContent_MakeAvailable() is not suitable for here :(
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nb>FetchContent_GetProperties</span><span class=p>(</span><span class=s>googletest</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>if</span><span class=p>(</span><span class=s>NOT</span> <span class=s>googletest_POPULATED</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    	<span class=nb>FetchContent_Populate</span><span class=p>(</span><span class=s>googletest</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=nb>add_subdirectory</span><span class=p>(</span><span class=o>${</span><span class=nv>googletest_SOURCE_DIR</span><span class=o>}</span> <span class=o>${</span><span class=nv>googletest_BINARY_DIR</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>endif</span><span class=p>()</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>add_executable</span><span class=p>(</span><span class=s>exec_name</span> <span class=s>exec_name.cc</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>target_link_libraries</span><span class=p>(</span><span class=s>exec_name</span> <span class=s>gtest</span> <span class=s>gtest_main</span><span class=p>)</span><span class=err>
</span></span></span></code></pre></div><h2 id=总结>总结<a href=#总结 class=hanchor arialabel=Anchor>⚓</a></h2><p>gtest 目前从我的使用角度来说，只剩下可视化这个问题了。如果 gtest 输出的 xml 支持 cunit 风格，且不需要太复杂的设置进行格式转换，就很好了。</p><h2 id=参考>参考<a href=#参考 class=hanchor arialabel=Anchor>⚓</a></h2><ul><li><p><em><a href=https://www.cnblogs.com/coderzh/archive/2009/04/06/1430396.html>gtest 事件机制</a></em></p></li><li><p><em><a href=https://paul.pub/gtest-and-coverage/>gtest 单元测试与代码覆盖率</a></em></p></li><li><p><em><a href=https://www.cnblogs.com/linux-sir/archive/2012/08/25/2654557.html>cunit 单元测试</a></em></p></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/post/0009/><span class=button__icon>←</span>
<span class=button__text>gcc optimization</span></a></span>
<span class="button next"><a href=/post/0007/><span class=button__text>CMake components - use Doxygen</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=zexsphere/zexsphere.github.io issue-term=pathname theme=dark-blue crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#单元测试框架>单元测试框架</a></li><li><a href=#可视化>可视化</a></li><li><a href=#集成到-cmake>集成到 CMake</a></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>:: Powered by <a href=http://gohugo.io>Hugo</a> 0.115.4</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><a id=back-to-top style=display:inline-block href=javascript:void(0); onclick='window.scrollTo({top:0,behavior:"smooth"})'><span class="iconfont icon-top"></span></a>
<script src=/assets/main.js?d41d8cd98f00b204e9800998ecf8427e></script>
<script>const addCopyButtons=function(e){document.querySelectorAll("pre > code").forEach(function(t){const n=document.createElement("button");n.className="copy-code-button",n.type="button",n.innerText="Copy";const s=document.createElement("div");s.className="copy-code-button-wrap",s.appendChild(n),n.addEventListener("click",function(){e.writeText(t.innerText).then(function(){n.blur(),n.innerText="✔️",setTimeout(function(){n.innerText="Copy"},2e3)},function(){n.innerText="Error"})});const o=t.parentNode;o.insertAdjacentElement("beforebegin",s)})},loadScript=(e,t)=>{var n=document.createElement("script");n.onerror=e=>{throw new URIError("The script "+e.target.src+" didn't load correctly.")},t&&(n.onload=t),document.head.insertAdjacentElement("beforeend",n),n.src=e},loadMermaidOnNeed=()=>{document.querySelectorAll(".mermaid").length>0&&loadScript("https://cdn.jsdelivr.net/npm/mermaid@8.10.1/dist/mermaid.min.js",()=>{document.head.insertAdjacentHTML("beforeend",`<style>.mermaid svg { background-color: #dadcd8 !important; }</style>`),mermaid.initialize({startOnLoad:!1,securityLevel:"strict",logLevel:1,theme:"neutral"}),mermaid.init(),console.log("mermaid init done")})},loadPlantUMLOnNeed=()=>{let e="language-plantuml";document.querySelectorAll("[class^="+e+"]").length>0&&loadScript("https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js",()=>{(function(){Array.prototype.forEach.call(document.querySelectorAll("[class^="+e+"]"),function(e){let t=document.createElement("IMG");t.loading="lazy",t.src="http://www.plantuml.com/plantuml/svg/~1"+plantumlEncoder.encode(e.innerText),e.parentNode.insertBefore(t,e),e.style.display="none"})})(),console.log("PlantUML init done")})};window.addEventListener("load",function(){const t=document.links;for(let e=0,n=t.length;e<n;e++)t[e].hostname!=window.location.hostname&&!t[e].href.startsWith("javascript:")&&!t[e].href.startsWith("mailto:")&&(t[e].target="_blank");document.querySelectorAll("#TableOfContents li").length>0&&(document.querySelector("#post-toc").style.display="block"),document.querySelectorAll("#post-toc a").forEach(e=>{e.addEventListener("click",e=>{document.querySelectorAll("#post-toc a").forEach(e=>{e.classList.remove("active")}),e.target.classList.add("active")})}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();let t=this.getAttribute("href").substring(1);window.history.pushState({},"","#"+t),document.getElementById(t).scrollIntoView({behavior:"smooth"})})}),navigator&&navigator.clipboard&&addCopyButtons(navigator.clipboard),loadPlantUMLOnNeed(),loadMermaidOnNeed()})</script></div></body></html>