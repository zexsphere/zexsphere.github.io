<!doctype html><html lang=en><head><meta charset=utf-8><meta name=referrer content="same-origin"><title>Self-hosting services with https :: Zex</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="结构图 基础点 容器可以加入同一个网络中，并通过容器名相互通信 命令行下程序与用户的交互可以用 expect 脚本自动化控制 步骤 1. 生成自签名证书 openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 2. 配置 nginx.conf 指定证书，并设置代理转发
server { listen 11443 ssl; server_name localhost; ssl_certificate /usr/local/nginx/certs/cert.pem; ssl_certificate_key /usr/local/nginx/certs/key.pem; location / { proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://web:80; } # ...... } # server { # 新增 Web 服务 # ... # } 3. expect 脚本 输入启动时的证书密码，这一步其实并不安全，完全是为了简化操作步骤。
# pem.expect #!"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/post/0005/><link rel=stylesheet href=/assets/style.min.css?d41d8cd98f00b204e9800998ecf8427e><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/favicon/apple-icon-precomposed.png><link rel="shortcut icon" href=/img/favicon/orange.png><meta name=twitter:card content="summary"><meta property="og:type" content="article"><meta property="og:title" content="Self-hosting services with https :: Zex"><meta property="og:description" content="对自托管服务使用 ssl 加密访问"><meta property="og:url" content="/post/0005/"><meta property="og:site_name" content="Zex"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-08-07 10:57:10 +0800 +0800"></head><body><div class="container headings--one-size"><header class=header style=background-image:url(/img/mountain/mountains-g47d3aaa15_1280.jpg);background-position:50%;background-repeat:no-repeat;background-size:cover><div class=header__inner><div class=header__logo><a href=/><div class=logo>Zex</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>关于</a></li><li><a href=/archive>归档</a></li><li><a href=/series/life>生活</a></li><li><a href=/series/code>编程</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>关于</a></li><li><a href=/archive>归档</a></li><li><a href=/series/life>生活</a></li><li><a href=/series/code>编程</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title>Self-hosting services with https</h1><div class=post-meta><span class=post-date>2023-08-07</span>
<span class=post-author>::
zexsphere</span></div><div class=post-content><div><h2 id=结构图>结构图<a href=#结构图 class=hanchor arialabel=Anchor>⚓</a></h2><p><a class=post-img-lb href=https://pic.imgdb.cn/item/64d0e1231ddac507cc915777.png data-caption><img src=https://pic.imgdb.cn/item/64d0e1231ddac507cc915777.png alt></a></p><h2 id=基础点>基础点<a href=#基础点 class=hanchor arialabel=Anchor>⚓</a></h2><ol><li>容器可以加入同一个网络中，并通过容器名相互通信</li><li>命令行下程序与用户的交互可以用 expect 脚本自动化控制</li></ol><h2 id=步骤>步骤<a href=#步骤 class=hanchor arialabel=Anchor>⚓</a></h2><h3 id=1-生成自签名证书>1. 生成自签名证书<a href=#1-生成自签名证书 class=hanchor arialabel=Anchor>⚓</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days <span class=m>365</span>
</span></span></code></pre></div><h3 id=2-配置-nginxconf>2. 配置 nginx.conf<a href=#2-配置-nginxconf class=hanchor arialabel=Anchor>⚓</a></h3><p>指定证书，并设置代理转发</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>    server <span class=o>{</span>
</span></span><span class=line><span class=cl>        listen       <span class=m>11443</span> ssl<span class=p>;</span>
</span></span><span class=line><span class=cl>        server_name  localhost<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        ssl_certificate       /usr/local/nginx/certs/cert.pem<span class=p>;</span>
</span></span><span class=line><span class=cl>        ssl_certificate_key   /usr/local/nginx/certs/key.pem<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        location / <span class=o>{</span>
</span></span><span class=line><span class=cl>            proxy_set_header  Host              <span class=nv>$http_host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            proxy_set_header  X-Real-IP         <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            proxy_set_header  X-Forwarded-For   <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            proxy_pass http://web:80<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1># ......</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># server { # 新增 Web 服务</span>
</span></span><span class=line><span class=cl>    <span class=c1>#    ...</span>
</span></span><span class=line><span class=cl>    <span class=c1># }</span>
</span></span></code></pre></div><h3 id=3-expect-脚本>3. expect 脚本<a href=#3-expect-脚本 class=hanchor arialabel=Anchor>⚓</a></h3><p>输入启动时的证书密码，这一步其实并不安全，完全是为了简化操作步骤。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># pem.expect</span>
</span></span><span class=line><span class=cl><span class=c1>#!/usr/bin/expect</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>set</span> timeout <span class=m>30</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> password <span class=s2>&#34;123456&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>spawn /usr/local/nginx/sbin/nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PEM&#34;</span> <span class=o>{</span> send <span class=s2>&#34;</span><span class=nv>$password</span><span class=s2>\r&#34;</span><span class=p>;</span> exp_continue <span class=o>}</span> <span class=c1># 多个使用 SSL 的服务需要重复 send 多次</span>
</span></span><span class=line><span class=cl>    eof
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=4-编译生成-nginx-镜像>4. 编译生成 nginx 镜像<a href=#4-编译生成-nginx-镜像 class=hanchor arialabel=Anchor>⚓</a></h3><p>也可以直接用 dockerhub 里现成的镜像，不过打算有空读读源码，先熟悉下过程</p><p><code>docker build -t nginx-proxy .</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ubuntu</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /code</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># ubuntu 替换镜像源</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> sed -i s@/security.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> apt-get clean <span class=o>&amp;&amp;</span> apt-get update -y<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 编译 nginx 的库 &amp; 工具</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get install gcc make libz-dev libpcre3-dev libssl-dev expect wget -y<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 编译 nginx</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> wget http://nginx.org/download/nginx-1.24.0.tar.gz <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> tar xf ./nginx-1.24.0.tar.gz <span class=o>&amp;&amp;</span> <span class=nb>cd</span> ./nginx-1.24.0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> ./configure --prefix<span class=o>=</span>/usr/local/nginx --with-http_ssl_module  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> make <span class=o>&amp;&amp;</span> make install<span class=err>
</span></span></span></code></pre></div><h3 id=5-compose-部署>5. compose 部署<a href=#5-compose-部署 class=hanchor arialabel=Anchor>⚓</a></h3><p>创建互联网络 <code>docker network create ngx-net</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 内部监听端口 80  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>python:3.7-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>ngx-net</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tty</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nginx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx-proxy:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>ngx-net</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>ngx/certs:/usr/local/nginx/certs</span><span class=w> </span><span class=c># 存放步骤1 pem 证书</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>ngx/conf:/usr/local/nginx/conf  </span><span class=w> </span><span class=c># 存放步骤2 conf 文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>ngx/sbin:/usr/local/nginx/sbin  </span><span class=w> </span><span class=c># 存放步骤3 expect 脚本</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>11443</span><span class=p>:</span><span class=m>11443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tty</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><h3 id=6-启动>6. 启动<a href=#6-启动 class=hanchor arialabel=Anchor>⚓</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker compose up -d
</span></span><span class=line><span class=cl>$ docker <span class=nb>exec</span> -it nginx-proxy expect pem.expect
</span></span></code></pre></div><h2 id=总结>总结<a href=#总结 class=hanchor arialabel=Anchor>⚓</a></h2><p>容器隔离了环境，复杂度一部分转移到了部署层面上。</p><p>自签名证书一般多用于自嗨，不属于正规流派，应用场景不大。</p><p>dockerfile 和 compose 还真是方便。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/post/0006/><span class=button__icon>←</span>
<span class=button__text>Intro to Tun/Tap</span></a></span>
<span class="button next"><a href=/post/0004/><span class=button__text>Memory problems in C</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=zexsphere/zexsphere.github.io issue-term=pathname theme=dark-blue crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#结构图>结构图</a></li><li><a href=#基础点>基础点</a></li><li><a href=#步骤>步骤</a><ul><li><a href=#1-生成自签名证书>1. 生成自签名证书</a></li><li><a href=#2-配置-nginxconf>2. 配置 nginx.conf</a></li><li><a href=#3-expect-脚本>3. expect 脚本</a></li><li><a href=#4-编译生成-nginx-镜像>4. 编译生成 nginx 镜像</a></li><li><a href=#5-compose-部署>5. compose 部署</a></li><li><a href=#6-启动>6. 启动</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>:: Powered by <a href=http://gohugo.io>Hugo</a> 0.115.4</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><a id=back-to-top style=display:inline-block href=javascript:void(0); onclick='window.scrollTo({top:0,behavior:"smooth"})'><span class="iconfont icon-top"></span></a>
<script src=/assets/main.js?d41d8cd98f00b204e9800998ecf8427e></script>
<script>const addCopyButtons=function(e){document.querySelectorAll("pre > code").forEach(function(t){const n=document.createElement("button");n.className="copy-code-button",n.type="button",n.innerText="Copy";const s=document.createElement("div");s.className="copy-code-button-wrap",s.appendChild(n),n.addEventListener("click",function(){e.writeText(t.innerText).then(function(){n.blur(),n.innerText="✔️",setTimeout(function(){n.innerText="Copy"},2e3)},function(){n.innerText="Error"})});const o=t.parentNode;o.insertAdjacentElement("beforebegin",s)})},loadScript=(e,t)=>{var n=document.createElement("script");n.onerror=e=>{throw new URIError("The script "+e.target.src+" didn't load correctly.")},t&&(n.onload=t),document.head.insertAdjacentElement("beforeend",n),n.src=e},loadMermaidOnNeed=()=>{document.querySelectorAll(".mermaid").length>0&&loadScript("https://cdn.jsdelivr.net/npm/mermaid@8.10.1/dist/mermaid.min.js",()=>{document.head.insertAdjacentHTML("beforeend",`<style>.mermaid svg { background-color: #dadcd8 !important; }</style>`),mermaid.initialize({startOnLoad:!1,securityLevel:"strict",logLevel:1,theme:"neutral"}),mermaid.init(),console.log("mermaid init done")})},loadPlantUMLOnNeed=()=>{let e="language-plantuml";document.querySelectorAll("[class^="+e+"]").length>0&&loadScript("https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js",()=>{(function(){Array.prototype.forEach.call(document.querySelectorAll("[class^="+e+"]"),function(e){let t=document.createElement("IMG");t.loading="lazy",t.src="http://www.plantuml.com/plantuml/svg/~1"+plantumlEncoder.encode(e.innerText),e.parentNode.insertBefore(t,e),e.style.display="none"})})(),console.log("PlantUML init done")})};window.addEventListener("load",function(){const t=document.links;for(let e=0,n=t.length;e<n;e++)t[e].hostname!=window.location.hostname&&!t[e].href.startsWith("javascript:")&&!t[e].href.startsWith("mailto:")&&(t[e].target="_blank");document.querySelectorAll("#TableOfContents li").length>0&&(document.querySelector("#post-toc").style.display="block"),document.querySelectorAll("#post-toc a").forEach(e=>{e.addEventListener("click",e=>{document.querySelectorAll("#post-toc a").forEach(e=>{e.classList.remove("active")}),e.target.classList.add("active")})}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();let t=this.getAttribute("href").substring(1);window.history.pushState({},"","#"+t),document.getElementById(t).scrollIntoView({behavior:"smooth"})})}),navigator&&navigator.clipboard&&addCopyButtons(navigator.clipboard),loadPlantUMLOnNeed(),loadMermaidOnNeed()})</script></div></body></html>