<!doctype html><html lang=en><head><meta charset=utf-8><meta name=referrer content="same-origin"><title>Intro to Tun/Tap :: Zex</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="该图片由 Simon Oberthaler 在 Pixabay 上 发布
原理 +---------------+ +---------------+ +---------------+ | application A | | application B | | application C | +-------^-------+ +-------+-------+ +-------+-------+ user-mode | | | +-----------------------------------------------------------------------------------+ | | | | +-------v-------------------------v-------+ kernel-mode | | layer socket | | +--------------------^--------------------+ | | | +--------------------v--------------------+ | | TCP/IP stack | | +--------^-----------------------^--------+ | | | +-------v-------+ +--------v--------+ +--------v--------+ | /dev/net/tun | | Drivers for | | Drivers for | | char drivers| | virtual NIC | | pysical NIC | +-------^-------+ +--------^--------+ +--------^--------+ | | | | +--------v--------+ +--------v--------+ | (tun tap)| virtual NIC | | pysical NIC | | +--------^--------+ +--------^--------+ | | | | | | +--------------------------+ | | +-----------------------------------------------------------------------------------+ | +--------------+ | | Internet &amp;lt;-----+ +--------------+ 实践 code #include &amp;lt;linux/if."><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=/post/0006/><link rel=stylesheet href=/assets/style.min.css?d41d8cd98f00b204e9800998ecf8427e><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/favicon/apple-icon-precomposed.png><link rel="shortcut icon" href=/img/favicon/orange.png><meta name=twitter:card content="summary"><meta property="og:type" content="article"><meta property="og:title" content="Intro to Tun/Tap :: Zex"><meta property="og:description" content="虚拟网络接口"><meta property="og:url" content="/post/0006/"><meta property="og:site_name" content="Zex"><meta property="og:image" content="https://pic.imgdb.cn/item/64d5733c1ddac507cc484a2e.jpg"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-08-10 09:54:51 +0800 +0800"></head><body><div class="container center headings--one-size"><header class=header style=background-image:url(/img/mountain/mountains-g47d3aaa15_1280.jpg);background-position:50%;background-repeat:no-repeat;background-size:cover><div class=header__inner><div class=header__logo><a href=/><div class=logo>Zex</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title>Intro to Tun/Tap</h1><div class=post-meta><span class=post-date>2023-08-10</span>
<span class=post-author>::
zexsphere</span></div><span class=post-tags>#<a href=/tags/net/>net</a>&nbsp;</span>
<img src=https://pic.imgdb.cn/item/64d5733c1ddac507cc484a2e.jpg class=post-cover><div class=post-content><div><p>该图片由 Simon Oberthaler 在 Pixabay 上
<a href=https://pixabay.com/zh/photos/elephants-herd-pachyderms-mammals-8171393/>发布</a></p><h2 id=原理>原理<a href=#原理 class=hanchor arialabel=Anchor>⚓</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-basic data-lang=basic><span class=line><span class=cl><span class=o>+---------------+</span><span class=w>         </span><span class=o>+---------------+</span><span class=w>         </span><span class=o>+---------------+</span>
</span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=vg>application</span><span class=w> </span><span class=vg>A</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=vg>application</span><span class=w> </span><span class=vg>B</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=vg>application</span><span class=w> </span><span class=vg>C</span><span class=w> </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>+-------^-------+</span><span class=w>         </span><span class=o>+-------+-------+</span><span class=w>         </span><span class=o>+-------+-------+</span><span class=w>       </span><span class=vg>user</span><span class=o>-</span><span class=vg>mode</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w>                         </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>+-----------------------------------------------------------------------------------+</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                         </span><span class=o>|</span><span class=w>                         </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                 </span><span class=o>+-------</span><span class=vg>v</span><span class=o>-------------------------</span><span class=vg>v</span><span class=o>-------+</span><span class=w>     </span><span class=vg>kernel</span><span class=o>-</span><span class=vg>mode</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                 </span><span class=o>|</span><span class=w>               </span><span class=vg>layer</span><span class=w> </span><span class=vg>socket</span><span class=w>              </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                 </span><span class=o>+--------------------^--------------------+</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                                      </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                 </span><span class=o>+--------------------</span><span class=vg>v</span><span class=o>--------------------+</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                 </span><span class=o>|</span><span class=w>              </span><span class=vg>TCP</span><span class=o>/</span><span class=vg>IP</span><span class=w> </span><span class=vg>stack</span><span class=w>               </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                 </span><span class=o>+--------^-----------------------^--------+</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>+-------</span><span class=vg>v</span><span class=o>-------+</span><span class=w>         </span><span class=o>+--------</span><span class=vg>v</span><span class=o>--------+</span><span class=w>     </span><span class=o>+--------</span><span class=vg>v</span><span class=o>--------+</span>
</span></span><span class=line><span class=cl><span class=o>|</span><span class=w> </span><span class=o>/</span><span class=vg>dev</span><span class=o>/</span><span class=vg>net</span><span class=o>/</span><span class=vg>tun</span><span class=w>  </span><span class=o>|</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=vg>Drivers</span><span class=w> </span><span class=vg>for</span><span class=w>     </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=vg>Drivers</span><span class=w> </span><span class=vg>for</span><span class=w>     </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>|</span><span class=w>   </span><span class=vg>char</span><span class=w> </span><span class=vg>drivers</span><span class=o>|</span><span class=w>         </span><span class=o>|</span><span class=w>    </span><span class=vg>virtual</span><span class=w> </span><span class=vg>NIC</span><span class=w>  </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=vg>pysical</span><span class=w> </span><span class=vg>NIC</span><span class=w>   </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>+-------^-------+</span><span class=w>         </span><span class=o>+--------^--------+</span><span class=w>     </span><span class=o>+--------^--------+</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                 </span><span class=o>+--------</span><span class=vg>v</span><span class=o>--------+</span><span class=w>     </span><span class=o>+--------</span><span class=vg>v</span><span class=o>--------+</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>        </span><span class=p>(</span><span class=vg>tun</span><span class=w> </span><span class=vg>tap</span><span class=p>)</span><span class=o>|</span><span class=w>    </span><span class=vg>virtual</span><span class=w> </span><span class=vg>NIC</span><span class=w>  </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=vg>pysical</span><span class=w> </span><span class=vg>NIC</span><span class=w>   </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                 </span><span class=o>+--------^--------+</span><span class=w>     </span><span class=o>+--------^--------+</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>                          </span><span class=o>|</span><span class=w>                       </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>        </span><span class=o>+--------------------------+</span><span class=w>                       </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>                                                           </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=o>+-----------------------------------------------------------------------------------+</span>
</span></span><span class=line><span class=cl><span class=w>                                                           </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>                                      </span><span class=o>+--------------+</span><span class=w>     </span><span class=o>|</span>
</span></span><span class=line><span class=cl><span class=w>                                      </span><span class=o>|</span><span class=w>   </span><span class=vg>Internet</span><span class=w>   </span><span class=o>&lt;-----+</span>
</span></span><span class=line><span class=cl><span class=w>                                      </span><span class=o>+--------------+</span>
</span></span></code></pre></div><h2 id=实践>实践<a href=#实践 class=hanchor arialabel=Anchor>⚓</a></h2><h3 id=code>code<a href=#code class=hanchor arialabel=Anchor>⚓</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/if.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/if_tun.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/ioctl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>tun_alloc</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>dev</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>ifreq</span> <span class=n>ifr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>clonedev</span> <span class=o>=</span> <span class=s>&#34;/dev/net/tun&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* 打开 /dev/net/tun */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=n>clonedev</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ifr</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>ifr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>ifr</span><span class=p>.</span><span class=n>ifr_flags</span> <span class=o>=</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* 未指定设备名称时，由内核分配设备名 */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>dev</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>strncpy</span><span class=p>(</span><span class=n>ifr</span><span class=p>.</span><span class=n>ifr_name</span><span class=p>,</span> <span class=n>dev</span><span class=p>,</span> <span class=n>IFNAMSIZ</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* 通过 ioctl() 向内核注册网络设备，完成创建虚拟接口
</span></span></span><span class=line><span class=cl><span class=cm>     * 通过文件描述符 fd 关联，与接口通信 */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>err</span> <span class=o>=</span> <span class=nf>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>TUNSETIFF</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>ifr</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//strcpy(dev, ifr.ifr_name); // this line leads to errors.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=n>nread</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>1500</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>fd</span> <span class=o>=</span> <span class=nf>tun_alloc</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>IFF_TUN</span> <span class=o>|</span> <span class=n>IFF_NO_PI</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;tun alloc failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>nread</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buffer</span><span class=p>)))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;read failed!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=cm>/* process packets here */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* 程序关闭文件描述符、网络设备和所有相应的路线将会消失 */</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=compile--run>compile & run<a href=#compile--run class=hanchor arialabel=Anchor>⚓</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ gcc tun.c -o tun
</span></span><span class=line><span class=cl>$ ./tun
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># open another window</span>
</span></span><span class=line><span class=cl>$ ip addr add 10.0.0.1/24 dev tun0
</span></span><span class=line><span class=cl>$ ip link <span class=nb>set</span> tun0 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># test packet acceptance</span>
</span></span><span class=line><span class=cl>$ ping 10.0.0.2
</span></span><span class=line><span class=cl>PING 10.0.0.2 <span class=o>(</span>10.0.0.2<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.0.0.2: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.024 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.0.0.2: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.035 ms
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h2 id=参考>参考<a href=#参考 class=hanchor arialabel=Anchor>⚓</a></h2><ul><li><p><em><a href=https://backreference.org/2010/03/26/tuntap-interface-tutorial/>Tun/Tap interface tutorial</a></em></p></li><li><p><em><a href=https://www.kernel.org/doc/Documentation/networking/tuntap.txt>Documentation/networking/tuntap.txt</a></em></p></li><li><p><em><a href=https://github.com/torvalds/linux/blob/v4.4/drivers/net/tun.c>net/tun.c</a></em></p></li><li><p><em><a href=https://zhuanlan.zhihu.com/p/462501573>云原生虚拟化：一文读懂网络虚拟化之 tun/tap 网络设备</a></em></p></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/post/0005/><span class=button__text>Self-hosting services using the nginx ssl proxy</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=zexsphere/zexsphere.github.io issue-term=pathname theme=dark-blue crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#原理>原理</a></li><li><a href=#实践>实践</a><ul><li><a href=#code>code</a></li><li><a href=#compile--run>compile & run</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>:: Powered by <a href=http://gohugo.io>Hugo</a> 0.115.4</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><a id=back-to-top style=display:inline-block href=javascript:void(0); onclick='window.scrollTo({top:0,behavior:"smooth"})'><span class="iconfont icon-top"></span></a>
<script src=/assets/main.js?d41d8cd98f00b204e9800998ecf8427e></script>
<script>const addCopyButtons=function(e){document.querySelectorAll("pre > code").forEach(function(t){const n=document.createElement("button");n.className="copy-code-button",n.type="button",n.innerText="Copy";const s=document.createElement("div");s.className="copy-code-button-wrap",s.appendChild(n),n.addEventListener("click",function(){e.writeText(t.innerText).then(function(){n.blur(),n.innerText="✔️",setTimeout(function(){n.innerText="Copy"},2e3)},function(){n.innerText="Error"})});const o=t.parentNode;o.insertAdjacentElement("beforebegin",s)})},loadScript=(e,t)=>{var n=document.createElement("script");n.onerror=e=>{throw new URIError("The script "+e.target.src+" didn't load correctly.")},t&&(n.onload=t),document.head.insertAdjacentElement("beforeend",n),n.src=e},loadMermaidOnNeed=()=>{document.querySelectorAll(".mermaid").length>0&&loadScript("https://cdn.jsdelivr.net/npm/mermaid@8.10.1/dist/mermaid.min.js",()=>{document.head.insertAdjacentHTML("beforeend",`<style>.mermaid svg { background-color: #dadcd8 !important; }</style>`),mermaid.initialize({startOnLoad:!1,securityLevel:"strict",logLevel:1,theme:"neutral"}),mermaid.init(),console.log("mermaid init done")})},loadPlantUMLOnNeed=()=>{let e="language-plantuml";document.querySelectorAll("[class^="+e+"]").length>0&&loadScript("https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js",()=>{(function(){Array.prototype.forEach.call(document.querySelectorAll("[class^="+e+"]"),function(e){let t=document.createElement("IMG");t.loading="lazy",t.src="http://www.plantuml.com/plantuml/svg/~1"+plantumlEncoder.encode(e.innerText),e.parentNode.insertBefore(t,e),e.style.display="none"})})(),console.log("PlantUML init done")})};window.addEventListener("load",function(){const t=document.links;for(let e=0,n=t.length;e<n;e++)t[e].hostname!=window.location.hostname&&!t[e].href.startsWith("javascript:")&&!t[e].href.startsWith("mailto:")&&(t[e].target="_blank");document.querySelectorAll("#TableOfContents li").length>0&&(document.querySelector("#post-toc").style.display="block"),document.querySelectorAll("#post-toc a").forEach(e=>{e.addEventListener("click",e=>{document.querySelectorAll("#post-toc a").forEach(e=>{e.classList.remove("active")}),e.target.classList.add("active")})}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();let t=this.getAttribute("href").substring(1);window.history.pushState({},"","#"+t),document.getElementById(t).scrollIntoView({behavior:"smooth"})})}),navigator&&navigator.clipboard&&addCopyButtons(navigator.clipboard),loadPlantUMLOnNeed(),loadMermaidOnNeed()})</script></div></body></html>